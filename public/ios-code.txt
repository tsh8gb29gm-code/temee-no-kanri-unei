// --- æ‰‹é † 1: ContentView.swift ã«ã“ã‚Œã‚’è²¼ã‚Šä»˜ã‘ã‚‹ ---

import SwiftUI
import WebKit
import WidgetKit

struct ContentView: View {
    var body: some View {
        MyWebView()
            .edgesIgnoringSafeArea(.all)
    }
}

struct MyWebView: UIViewRepresentable {
    func makeCoordinator() -> Coordinator {
        Coordinator()
    }
    func makeUIView(context: Context) -> WKWebView {
        let config = WKWebViewConfiguration()
        config.userContentController.add(context.coordinator, name: "timerHandler")
        return WKWebView(frame: .zero, configuration: config)
    }
    func updateUIView(_ webView: WKWebView, context: Context) {
        if webView.url == nil {
            let url = URL(string: "https://temee-no-kanri-unei.vercel.app/")!
            webView.load(URLRequest(url: url))
        }
    }
    class Coordinator: NSObject, WKScriptMessageHandler {
        func userContentController(_ ucc: WKUserContentController, didReceive msg: WKScriptMessage) {
            if let dict = msg.body as? [String: Any] {
                let action = dict["action"] as? String ?? ""
                let itemName = dict["itemName"] as? String ?? ""
                let df = UserDefaults.standard
                if action == "start" {
                    df.set(itemName, forKey: "curr_item")
                    df.set(true, forKey: "is_running")
                } else {
                    df.set(false, forKey: "is_running")
                }
                // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’å¼·åˆ¶æ›´æ–°
                WidgetCenter.shared.reloadAllTimelines()
            }
        }
    }
}

// --- æ‰‹é † 2: æ–°ã—ãä½œã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆMyWidget.swiftï¼‰ã«ã“ã‚Œã‚’è²¼ã‚Šä»˜ã‘ã‚‹ ---
// (â€»ã‚‚ã—ä¸€ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚„ã‚ŠãŸã„å ´åˆã¯ã€ãã®ã¾ã¾ ContentView.swift ã®ä¸€ç•ªä¸‹ã«è¿½è¨˜ã—ã¦ã‚‚OKã§ã™)

import WidgetKit
import SwiftUI

struct TimerEntry: TimelineEntry {
    let date: Date
    let itemName: String
    let isRunning: Bool
}

struct Provider: TimelineProvider {
    func placeholder(in context: Context) -> TimerEntry {
        TimerEntry(date: Date(), itemName: "æœªè¨ˆæ¸¬", isRunning: false)
    }
    func getSnapshot(in context: Context, completion: @escaping (TimerEntry) -> ()) {
        completion(TimerEntry(date: Date(), itemName: "ã‚µãƒ³ãƒ—ãƒ«", isRunning: true))
    }
    func getTimeline(in context: Context, completion: @escaping (Timeline<TimerEntry>) -> ()) {
        let standard = UserDefaults.standard
        let name = standard.string(forKey: "curr_item") ?? "æœªè¨ˆæ¸¬"
        let running = standard.bool(forKey: "is_running")
        let entry = TimerEntry(date: Date(), itemName: name, isRunning: running)
        let timeline = Timeline(entries: [entry], policy: .atEnd)
        completion(timeline)
    }
}

struct MyWidgetEntryView : View {
    var entry: Provider.Entry
    var body: some View {
        VStack(alignment: .leading, spacing: 5) {
            Text("ã¦ã‚ãˆã®ç®¡ç†é‹å–¶").font(.caption2).foregroundColor(.secondary)
            if entry.isRunning {
                Text("ğŸ”´ è¨ˆæ¸¬ä¸­").font(.caption).fontWeight(.bold).foregroundColor(.red)
                Text(entry.itemName).font(.headline)
            } else {
                Text("âšªï¸ å¾…æ©Ÿä¸­").font(.caption).foregroundColor(.gray)
                Text("ä½œæ¥­ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†").font(.subheadline)
            }
        }
        .containerBackground(for: .widget) { Color(red: 0.1, green: 0.1, blue: 0.2) }
    }
}

@main
struct MyWidget: Widget {
    let kind: String = "TemeeWidget"
    var body: some WidgetConfiguration {
        StaticConfiguration(kind: kind, provider: Provider()) { entry in
            MyWidgetEntryView(entry: entry)
        }
        .configurationDisplayName("ç¾åœ¨ã®ä½œæ¥­")
        .description("è¨ˆæ¸¬ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¡¨ç¤ºã—ã¾ã™ã€‚")
        .supportedFamilies([.systemSmall, .systemMedium])
    }
}
